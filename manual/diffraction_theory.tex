\begin{SCfigure}[1][htb]
\centering
\input{figures/DiffractionSetup.tex}
\caption{An X-Ray diffraction setup. X-rays scatter from a 
3-D sample and are captured by a 2-D detector. In this 
setup, the detector is perpendicular to the incoming 
x-ray beam.}
\label{DiffractionSetup}
\end{SCfigure}

\begin{SCfigure}[1][htb]
\centering
\input{figures/MeasureAngleFlatDetector.tex}
\caption{The same setup as in figure~\ref{DiffractionSetup}. 
Here, $2\theta$ is the scattering angle, $d$ is the distance 
from the crystal to the detector, and $r$ is the distance 
from the center of the detector to some particular point 
(which $2\theta$ is associated with). Note that by center 
of the detector, we mean the point on the detector where 
the beam would hit if did not interact with the crystal.}
\label{MeasureAngleFlatDetector}
\end{SCfigure}

X-ray diffraction is the process of shining a beam of 
high energy x-rays at a regular crystal. This can be 
modeled simply as in figure~\ref{DiffractionSetup}. 
What we have is a series of cones of light that 
emminate preferentially at certain angles normal to 
the outgoing beam. These cones of light are then 
detected by a flat detector, as is shown in the 
diagram. Usually, the interesting thing to measure 
when doing x-ray diffraction are the angles of these 
cones of light. By convention, this angle is called 
$2\theta$. Were the detector to be perfectly perpendicular 
to the incomming beam, as in figure~\ref{DiffractionSetup}, 
our cones of light would be detected as circles of high 
intensity. Were we to know certain experimental parameters 
such as the distance from the sample to the detector and 
the distance from the center of the detecor to a 
particular ring (or really any point on the detector), 
we could easily calculate the scattering angle of light 
that ended up at that particular spot on the detector. 
Suppose that the distance from the crystal to the detector 
is $d$ and the distance from the center of the detector 
to our particular point on the detector is $r$, as is 
shown in figure~\ref{MeasureAngleFlatDetector}. Then the 
scattering angle will be calculated as
\begin{equation}
    \tan2\theta = \frac{r}{d}
\end{equation}
Unfortunnatley, life is not always as simple as this and 
sometimes things get a little bit more complicated. In 
particular, the assumption taht the detector is exactly 
perpendicular to the incomming beam in unphysical. It 
will unphysical because perfect alignment can never be 
acheived and the detector will always in practice be 
slightly offset with respect to the incomming beam, even 
if only slightly. Failing to account for this tilt introduce 
a systematic error in measuring $2\theta$ and doing any other 
sort of data analysis. It is also unphysical because there 
are often good reasons to collect diffraction data from 
detectors at significant tilts . The main reason why this 
is done is to collect data at more extreme angles without 
needing to user larger detectors. This rational is made 
intuitive in figure~\ref{HigherQValues}. So there is a 
need to analyze detectors with tilted geometires. I will 
here present this theory of tilted detectors as it was 
developed by Abhik Kumar in~\cite{Kumar05}.\index{Abhik Kumar}
I could simply refer you to this paper for the results
that I will cite, but this paper is, in my oppinion,
almost absolutely undecipherable. So to save you the
misery of pooring through it yourself, I will do
my best to cleanly work through his findings. 

\begin{SCfigure}[1][htb]
\centering
\input{figures/HigherQValues.tex}
\caption{This diagram illustrates how tilted geometries 
allow for the collection of diffraction data at more 
extreme angles without the need for a larger detector.}
\label{HigherQValues}
\end{SCfigure}

What we are interested in is mathematically describing 
position coordinates on a tilted detector by relating 
them to more theoretically motivated quantities such as 
the scattering angles that would lead to a beam hitting
that particular point on the detector. This will be 
the equation that is needed in order to do the diffraction 
analysis. In order to do this, we must first work
out the transformation of points on a tilted detector
to points on an untilted detector. This is to say
that we want to figure out where on an untilted 
detector the beam would have hit were it to hit
that untilted detector instead of the tilted detector.
The point on the titled detector can be though of
as the shadow of the point on the untitled detector.
We will call the point on the untilted detector
$(x,y)$ as measured on the untilted detector
and the point on the tilted detector
$(x''',y''')$ as measured on the tilted detector. 
The reason for three primeds will become obvious
shortly. This is shown schematically in 
figure~\ref{PhysicalSetup}. Another way to think
about this problem is to imagine putting your 
head at the sample and then looking directly 
at some point $(x''',y''')$ on the real
tilted detector. What we want to figure out
is some point $(x,y)$ on an imagined untilted 
detector which would appear to be exactly out in
the same direction as the point on the tilted 
detector.


\begin{SCfigure}[1][htb]
\centering
\input{figures/PhysicalSetup.tex}
\caption{The setup of the experiment. Here, the detector 
is titled by some arbitrary angle with respect to the 
incoming beam. We will call some arbitrary point on 
the tilted detector as $(x''',y''')$. We are interested in 
relating this point to the point $(x,y)$ on some imagined 
un-tilted detector where a scattered beam would have hit 
were that tilted detector set up instead of the tilted
detector.}
\label{PhysicalSetup}
\end{SCfigure}

\subsection{The Three Tilt Angels}
\index{$\alpha$} \index{$\beta$} \index{Rotation} \index{Tilt}
In order to relate these points, we need to find a way to 
describe some arbitrary tilt. To do so, we will 
characterize some arbitrary detector tilt in terms of
3 independent tilts. We will characterize these tilts 
by two orthogonal rotations about the $x$ and $y$ axis 
followed by one rotation about the center of the detector.
These three angles are shown in action in figure~\ref{ThreeTilts}.
In order to find this relationship, we will apply each of these 
rotations separately, one after the other. 

\begin{figure}
\centering
\subfloat[The tilt angle $\beta$. This angle characterizes
a rotation around the $\hat{y}$ axis.]{
\label{beta}\input{figures/BetaRotation.tex}}
\subfloat[The tilt angle $\alpha$. This angle characterizes
a rotation around the $\hat{x'}$ axis. What 
exactly $\hat{x'}$ is will be described shortly]{
\label{alpha}\input{figures/AlphaRotation.tex}}
\subfloat[The rotation angle $R$. This is a rotation about
a vector normal to $\hat{x}''$ and $\hat{y}''$. What exactly
$\hat{x}''$ and $\hat{y}''$ are will be described shortly.]{
\label{R}\input{figures/Rotation.tex}}
\caption{Any detector tilt can be characterized 
as a rotation by $\beta$ followed by a rotation by $\alpha$
followed by a rotation around the center of the image by
$R$.}
\label{ThreeTilts}
\end{figure}


\subsection{The $\beta$ Tilt}

\begin{figure}
\centering
\subfloat[]{\label{PitchX_A}\input{figures/PitchX_A.tex}} 
\hfill
\subfloat[]{
\label{PitchX_B}\input{figures/PitchX_B.tex}}
\caption{A diagram of the situation depicted in 
figure~\ref{PhysicalSetup} where only the 
$\beta$ rotation has been applied.}
\label{PitchX}
\end{figure}

We will first apply a tilt around $\hat{y}$ by angle $\beta$.
To do this, we will first consider a point $(x,y)$ on an
untilted detector and see what point $(x',y')$ it is 
project onto on a detector tilted by angle $\beta$ around
$\hat{y}$

We will now take the point $(x,y)$ on the rotated plane 
and see what the coordinates of the corresponding point
$(x',y')$ would be if the point was projected onto another 
plane titled by an angle $\beta$ around $\hat{y}$.
This is to say that we will figure out where on the tilted
plane a beam would hit were it not to hit that detector 
instead of the un-tilted detector.
This relationship is diagrammed in figure~\ref{PitchX}.  
We can use the geometry of these diagrams to figure out
the relationships between these coordinates. Using
the property of similar triangles, we see that
\begin{equation}
    \frac{x}{d}=\frac{x'\cos\beta}{d+x'\sin\beta}.
\end{equation}
From this it follows that 
\begin{equation}\label{xTermsxPrime}
    \boxed{x = \frac{dx'\cos\beta}{d+x'\sin\beta}.}
\end{equation}
Using similar triangles again, we see that
\begin{eqnarray}
    \frac{y}{a}&=&\frac{y'}{a+b}\\
    \frac{d}{a}&=&\frac{d+x'\sin\beta}{a+b}.
\end{eqnarray}
from which it follows that
\begin{equation}\label{yTermsxPrime}
	\boxed{y= \frac{dy'}{d+x'\sin\beta}.}
\end{equation}
So, equation~\ref{xTermsxPrime} and \ref{yTermsxPrime} give us 
the proper geometrical equations for relating a point on the 
un-tilted plane $(x,y)$ to the corresponding point 
$(x',y')$ on the tilted plane.

\subsection{The $\alpha$ Roll}
We can now take this point $(x',y')$ on the tilted 
plane and project it onto another plane which has both 
a tilt and roll by an angle $\alpha$ around $\hat{x}$ 
applied to it. This is to say that we can determine 
where beam that hit a point on the tilted detector 
would have hit were it to instead hit a tilted and 
rolled detector. To do so, we take the plane which is
rotated by an angle $\beta$ around $\hat{y}$ and then
rotate it around the line $x'$ shown in figure~\ref{PitchX}.
This is shown schematically in figure~\ref{PitchY_A}. 
A more geometric view of the situation can be seen in 
figure~\ref{PitchY_B} and a cross section of the $y=0$
plane can be seen in figure~\ref{PitchY_C}.
Unforntunately, tehse diagrams are particularly hard to
stare at becaue since the $\alpha$ rotation is about the 
line $x'$, the plane is effectivley comming at us. 
I have done the best job that I can so you will just
have to bear with me an do your best..

\begin{SCfigure}[1][htb]
\centering
\input{figures/PitchY_A.tex} 
\label{PitchY_A}
\caption{.}
\end{SCfigure}

\begin{SCfigure}[1][htb]
\centering
\input{figures/PitchY_B.tex} 
\label{PitchY_B}
\caption{.}
\end{SCfigure}

\begin{SCfigure}[1][htb]
\centering
\input{figures/PitchY_C.tex} 
\label{PitchY_C}
\caption{.}
\end{SCfigure}

We can use these figures to deterimine the equations 
that we need. First, we can examine from figure~\ref{PitchY_C} 
that $f=y''\sin\alpha\cos\beta$. From figure~\ref{PitchY_B},
we see that $h=y''\cos\alpha$. Using the property of similar
trianges, we see that
\begin{equation}
    \frac{y}{a} = \frac{y''\cos\alpha}{a+b+c}
\end{equation}
Using similar triangles again, we see that
\begin{equation}
    \frac{d}{a} = \frac{d+x''\sin\beta+f}{a+b+c}
\end{equation}
From which we can deduce that
\begin{equation}\label{ytermsydoubleprime}
    \boxed{y=\frac{dy''\cos\alpha}{
    d+x''\sin\beta+y''\sin\alpha\cos\beta}.}
\end{equation}
We can now work out the $x$ term. First, we see that
$g=y''\sin\alpha\sin\beta$ and that 
$x''\cos\alpha=l+g$. Using similar triangles again, 
we see that 
\begin{equation}\label{xtermsxdoubleprime}
    \frac{x}{d} = \frac{l}{d+x''\sin\beta+
    y''\sin\alpha\cos\beta}
\end{equation}
Plugging in and simplifying, we get
\begin{equation}
    \boxed{x=\frac{d(x''\cos\beta-y''\sin\alpha)}{
    d+x''\sin\beta+y''\sin\alpha\cos\beta}.}
\end{equation}


\subsection{The $R$ Rotation}

\begin{SCfigure}[1][htb]
\centering
\input{figures/RotationFormula.tex}
\caption{This figure shows how points on a detector rotated 
by angle $R$ relate to the unrotated points. Remember that
a rotation of the plane is equivalent to the rotation of the
coordinates on the plane (which is what I have drawn).}
\label{RotationFormula}
\end{SCfigure}

We now have to deal with the final transformation. We will
rotate the pitched and tilted coordinate $(x'',y'')$ on the
pitched and tilted detector about the center of the
detector (the point $(0,0)$). We will call this final
rotated point $(x''',y''')$ and we will be able to calculate 
our point $(x,y)$ on the untilted detector in terms of the 
corresponding point $(x''',y''')$. This is shown schematically 
in figure~\ref{RotationFormula}. The equation for rotating 
around a point is just simply
\begin{eqnarray}\label{rotation}
    x''&=&x'''\cos R + y'''cos R\\
    y''&=&y'''\cos R - x'''cos R
\end{eqnarray}





$(x''',y''')$ is suppose to represent what we actually
measure on a real detector. Unfortunately, things are
not quite so easy. We do not actually measure these
values. The whole formalism assumes that we are 
measuring these distances from the point on the
detector where the beam would hit were it not to be
diffracted. Unfortunately, it is not at all clear
where this is. A discussion of finding the center will
be given in section~\ref{calibration}, but for now
lets simply note that there is some pixel on the detector
that is the center and worry about how to find it later. 
Lets call it $(x_c,y_c)$ 
We are now interested in some other pixel reading
on the detector which corresponds to the point
$(x''',y''')$. Lets call it $(x_d,y_d)$. Finally,
there is some material property of the detector 
describing the distance between each pixel
(e.g. \unit[1000]{mm/pixel}). We will call
this width $ps$. We can relate these quantities 
using:
\begin{align}\label{conversionToPixels}
    x'''&=(x_d-x_c) \times ps &
    y'''&=(y_d-y_c) \times ps
\end{align}
This means that, in terms of $(x_c,y_c)$ and $ps$,
we can relate $(x,y)$ and $(x_d,y_d)$ which are
directly measurable experimental quantities.



\subsection{Inverting the Equations}

We can invert these formula to get...

\subsection{Relation to $Q$, $2\theta$, and $\chi$}

\begin{SCfigure}[1][htb]
\centering
\input{figures/TwoTheta.tex}
\caption{For a particular point $(x,y)$, we
alwasy associate two quantities: $2\theta$ and $\chi$.
$2\theta$ is the angle of scattering 
of the beam, or the angle that an incomming beam is 
difflected by when it diffracts off the crystal. 
$\chi$ is a measure of the azimuthal angle around 
the beam. It tells you in what direction radially 
outwards (with respect to the undeflected beam) 
the outgoing beam was was scattered.}
\label{TwoTheta}
\end{SCfigure}

We now have a way of relating $(x''',y''')$, 
a point on a detector with a pitch $\beta$, 
tilt $\alpha$, and a roll $R$ applied to it, 
to a point on an an untilted detector $(x,y)$
where a beam of light would have interesected
were it not to hit the tilted detector.
With this relationship, we can now relate
these quantities to theoretically motivated 
quantities. In particular, the angle of scattering 
of a beam is by convention called $2\theta$ and a 
quanity measuring the scattering angle around the 
incomming beam is called $\chi$. These quantities 
are shown in figure~\ref{TwoTheta}. We can see that 
the relationship between $(x,y)$ and $2\theta$ and 
$\chi$ is
\begin{equation}\label{2thetatermsr}
    \tan2\theta = \frac{r}{d} = \frac{x^2+y^2}{d}
\end{equation}
and
\begin{equation}
    \tan\chi = \frac{y}{x}
\end{equation}
The quantity $Q$ is often used instead of $2\theta$. 
they are related by
\begin{equation}\label{qterms2theta}
    Q = \frac{4\pi \sin(2\theta/2)}{\lambda}
\end{equation}
The reason for using $Q$ instead of $2\theta$ is because 
diffraction theory shows that the $Q$ values of preferential 
scattering of a crystal is a material property independent 
of the experimental setup (such as $d$ and $\lambda$). 

Alternately, energy could be used in this formula.
To do so, energy can be related to wavelength using
the De Broglie's formula
\begin{equation}
E = \frac{hc}{\lambda}
\end{equation}
Finally, sometimes people use the quantity $D$ instead.
$D$ is related to $Q$ by
\begin{equation}\label{DtermsQ}
    D = \frac{2\pi}{Q}
\end{equation}
Using equation~\ref{conversionToPixels},
we now have a way of relating pixel
coordiantes $(x_d,y_d)$ read directly off
of a detector to the
theoretically motivated coordinates $(Q,\chi)$.
In order to do this conversion, we must use
the values $x_c$, $y_c$, $ps$, $d$, $\lambda$,
$\alpha$, $\beta$, and $R$. A discussion of
how these values can be determined so that
this transformation can in practice be done
will be given in section~\ref{calibration}


\subsection{Implementation In Code}

For reference, this section present the C source 
code used in the computer program to perform the 
transformation from pixel values on a tilted 
detector to $(Q,\chi)$ and back again. 
Listing~\ref{getTwoThetaChi} presents the function
\code{getTwoThetaChi()} which converts real pixel
coordaintes $(x_d,y_d)$, called \code{xPixel}
and \code{yPixel}, into the values $2\theta$ and $\chi$, 
called \code{twoTheta} and \code{chi} using the 
transformation described above. In order to perform 
this transformation, the program must be given
the values $x_c$, $y_c$, $ps$, $d$, 
$\alpha$, $\beta$, and $R$. For $x_c$ and $y_c$, 
the function takes in the variables $xCenter$ and
$yCenter$. The program takes in \code{pixelLength} 
and \code{pixelHeight} for $ps$ to identify the
width and height of each pixel (which should be the 
same). The program takes in the sines and cosines
of $\alpha$, $\beta$, and $R$ to allow for increased
efficiency. These variables are called \code{ cos\_beta}
\code{sin\_beta},\code{cos\_alpha},\code{sin\_alpha},
\code{cos\_rotation}, and \code{sin\_rotation}. 
Note that this function calculates $2\theta$ instead
of $Q$ or $D$ but it takes a trivial amount of work
to the additional conversion.
\begin{lstlisting}[caption={The Code to convert pixel coordinates on a real detector into $(Q,\chi)$ coordinates},label=getTwoThetaChi]
The Code will go here one of these days...
\end{lstlisting}
Listing~\ref{getXY} presents the function \code{getXY()} 
which does the inverse transformation of 
function~\ref{getTwoThetaChi}. It uses the same
terminology for parameters as that function.

\begin{lstlisting}[caption={The Code to convert $(Q,\chi)$ values into pixel coordinates on a real detector},label=getXY]
Other code will go here one of these days...
\end{lstlisting}



