\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/DiffractionSetup.tex}
    \caption{An X-Ray diffraction setup. X-rays scatter from a 
    3-D sample and are captured by a 2-D detector. In this 
    setup, the detector is perpendicular to the incoming 
    x-ray beam.}
    \label{DiffractionSetup}
\end{SCfigure}

X-ray diffraction is the process of shining a beam of 
high energy x-rays at a crystal. It is
modeled as in figure~\ref{DiffractionSetup}. 
Cones of light leave the crystal at certain angles to 
the incoming beam. These cones of light are then 
captured by a detector. Usually, the interesting thing
to measure when doing x-ray diffraction are the scattering
angles of these 
cones of light. By convention, the scattering angle of light,
measured with respect to the outgoing beam, is called 
$2\theta$. If we placed the detector perpendicular 
to the incoming beam, as in figure~\ref{DiffractionSetup}, 
the cones of light would be detected as circles of high 
intensity. Were we to know certain experimental parameters 
such as the distance from the sample to the detector and 
the distance from the center of the detector to a 
particular ring (or really any point on the detector), 
we could easily calculate the scattering angle of the
light that ended up at that particular spot on the detector. 
Suppose that the distance from the crystal to the detector 
is $d$ and the distance from the center of the detector 
to our particular point on the detector is $r$, as is 
shown in figure~\ref{MeasureAngleFlatDetector}. Then the 
scattering angle is
\begin{equation}
    \tan2\theta = \frac{r}{d}
\end{equation}
Here, the radius $r=\sqrt{x^2+y^2}$.
Unfortunnatley, life is not always as simple as this. In 
particular, the assumption that the detector is exactly 
perpendicular to the incoming beam is unphysical. It 
is unphysical because perfect alignment can never be 
achieved. The detector will always in practice be 
slightly offset with respect to the incoming beam, even 
if only slightly. Failing to account for this tilt would
introduce 
a systematic error in measuring $2\theta$ and doing any other 
sort of data analysis. It is also unphysical because there 
are often good reasons to collect diffraction data from 
detectors at significant tilts. The main reason 
would be to collect data at more extreme angles without 
needing to use a larger detector. This can be seen
in figure~\ref{HigherQValues}. 

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/MeasureAngleFlatDetector.tex}
    \caption{The same setup as in figure~\ref{DiffractionSetup}. 
    We are now interested in some particular point on the 
    detector. $2\theta$ is the scattering angle of the light
    that gets to this point, $d$ is the distance 
    from the crystal to the detector, and $r$ is the distance 
    from the center of the detector to some particular point 
    (which $2\theta$ is associated with). By center 
    of the detector, we mean the point on the detector where 
    the beam would hit if did not interact with the crystal.}
    \label{MeasureAngleFlatDetector}
\end{SCfigure}

So there is a need to analyze detectors that are 
tilted. I will present here a theory of tilted detectors 
first developed by Abhik Kumar in~\cite{Kumar05}.
\index{Abhik Kumar} My derviation will result in 
different formulas because of a different assumption
about how the detector is tilted from the initial to
the final state.

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/HigherQValues.tex}
    \caption{This diagram illustrates how tilted geometries 
    allow for the collection of diffraction data at more 
    extreme angles without the need for a larger detector.}
    \label{HigherQValues}
\end{SCfigure}

What we are interested in is mathematically describing 
position coordinates on a tilted detector by relating 
them to more theoretically motivated quantities such as 
the scattering angles that would lead to a beam hitting
that particular point on the detector. 
In order to do this, we must first work
out the transformation of points on a tilted detector
to points on an untilted detector. This is to say
that we want to figure out where on an untilted 
detector the beam would have hit were it to hit
that untilted detector instead of the tilted detector.
The point on the titled detector can be though of
as the shadow of the point on the untitled detector.
We will call the point on the untilted detector
as measured on the untilted detector $(x,y)$ 
and the corresponding point on the tilted detector
as measured on the tilted detector as $(x''',y''')$. 
The reason for three primes will become obvious
shortly. This is shown schematically in 
figure~\ref{PhysicalSetup}. Another way to think
about this problem is to imagine putting your 
head at the sample and then looking directly 
at some point $(x''',y''')$ on the real
tilted detector. What we want to figure out
is some corresponding point $(x,y)$ on an 
imagined untilted 
detector which would appear to eye to be 
in the same direction.

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/PhysicalSetup.tex}
    \caption{Here, the detector 
    is titled by some arbitrary angle with respect to the 
    incoming beam. We will call some arbitrary point on 
    the tilted detector $(x''',y''')$. We are interested in 
    relating this point to the point $(x,y)$ on some imagined 
    untilted detector where a scattered beam would have hit 
    were that tilted detector in place instead of the tilted
    detector.}
    \label{PhysicalSetup}
\end{SCfigure}

\section{The Three Tilt Angels}
\index{$\alpha$} \index{$\beta$} \index{Rotation} \index{Tilt}
In order to relate these points, we need to find a way to 
describe some arbitrary tilt. To do so, we will 
characterize a detector tilt in terms of
3 independent detector rotations. We will use
two orthogonal rotations about the $x$ and $y$ axis 
followed by one rotation about the center of the detector.
These three angles are shown in figure~\ref{ThreeTilts}.
We can solve our original problem much easier if we deal
with each rotation separately.

\begin{figure}[htb]
    \centering
    \subfloat[The tilt angle $\beta$. This angle characterizes
    a rotation around the $\hat{y}$ axis.]{
    \label{beta}\input{figures/BetaRotation.tex}}
    \subfloat[The tilt angle $\alpha$. This angle characterizes
    a rotation around the $\hat{x'}$ axis. What 
    exactly $\hat{x'}$ is will be described shortly]{
    \label{alpha}\input{figures/AlphaRotation.tex}}
    \subfloat[The rotation angle $R$. This is a rotation about
    a vector normal to $\hat{x}''$ and $\hat{y}''$. What exactly
    $\hat{x}''$ and $\hat{y}''$ are will be described shortly.]{
    \label{R}\input{figures/Rotation.tex}}
    \caption{Any detector tilt can be characterized 
    as a rotation by $\beta$ followed by a rotation by $\alpha$
    followed by a rotation around the center of the image by
    $R$.}
    \label{ThreeTilts}
\end{figure}

\section{\texorpdfstring{The $\beta$ Tilt}{The beta Tilt}}

\begin{figure}[htb]
    \centering
    \subfloat[]{\label{PitchX_A}\input{figures/PitchX_A.tex}} 
    \hfill
    \subfloat[]{
    \label{PitchX_B}\input{figures/PitchX_B.tex}}
    \caption{A diagram of the situation depicted in 
    figure~\ref{PhysicalSetup} where only the 
    $\beta$ rotation about $\hat y$ has been applied.}
    \label{PitchX}
\end{figure}

We will first apply a rotation around $\hat{y}$ by angle $\beta$.
To do this, we will first consider a point $(x,y)$ on an
untilted detector and project it onto some point $(x',y')$ 
on this rotated detector.
This is to say that we will figure out where on the detector
rotated by angle $\beta$ a
beam would hit were it to hit the tilted detector
instead of the untilted detector.
A diagram of this is shown in figure~\ref{PitchX}.  
We can use the geometry of these diagrams to figure out
the relationships between the coordinates. Using
the property of similar triangles, we see that
\begin{equation}
    \frac{x}{d}=\frac{x'\cos\beta}{d+x'\sin\beta}.
\end{equation}
From this it follows that 
\begin{equation}\label{xTermsxPrime}
    \boxed{x = \frac{dx'\cos\beta}{d+x'\sin\beta}.}
\end{equation}
Using similar triangles again, we see that
\begin{eqnarray}
    \frac{y}{a}&=&\frac{y'}{a+b}\\
    \frac{d}{a}&=&\frac{d+x'\sin\beta}{a+b}.
\end{eqnarray}
from which it follows that
\begin{equation}\label{yTermsxPrime}
	\boxed{y= \frac{dy'}{d+x'\sin\beta}.}
\end{equation}
So, equation~\ref{xTermsxPrime} and \ref{yTermsxPrime} give us 
the proper geometrical equations for relating a point on the 
untilted plane $(x,y)$ to the corresponding point 
$(x',y')$ on the first plane.

\section{\texorpdfstring{The $\alpha$ Roll}{The alpha Roll}}

We can now take this point $(x',y')$ on the tilted 
plane and project it onto another plane which has been
tilted by $\beta$ about $\hat y$ and a rolled by
$\alpha$ around $\hat{x'}$. 
To do so, we take the plane which is
rotated by an angle $\beta$ around $\hat{y}$ and then
rotate it around the line $x'$. 
This is diagrammed in figure~\ref{PitchY_A}. 
A more geometric diagram can be seen in 
figure~\ref{PitchY_B} and a cross section of the $y=0$
plane can be seen in figure~\ref{PitchY_C}.

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/PitchY_A.tex} 
    \label{PitchY_A}
    \caption{A diagram of a plane that has been 
    tilted about the $\hat y$ axis by angle
    $\beta$ and then about $\hat x'$ by angle
    $\alpha$.}
\end{SCfigure}

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/PitchY_B.tex} 
    \label{PitchY_B}
    \caption{Here is a more geometrical diagram
    of the figure shown in figure~\ref{PitchY_A}.}
\end{SCfigure}

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/PitchY_C.tex} 
    \label{PitchY_C}
    \caption{Here is a cross section of the $y=0$ plane
    of the figure shown in figure~\ref{PitchY_A}.}

\end{SCfigure}

We can use these figures to determine the equations 
that we need. We see from figure~\ref{PitchY_C} 
that $f=y''\sin\alpha\cos\beta$. From figure~\ref{PitchY_B},
we see that $h=y''\cos\alpha$. Using the property of similar
triangles, we see that
\begin{equation}
    \frac{y}{a} = \frac{y''\cos\alpha}{a+b+c}
\end{equation}
Using similar triangles again, we see that
\begin{equation}
    \frac{d}{a} = \frac{d+x''\sin\beta+f}{a+b+c}
\end{equation}
From which we can deduce that
\begin{equation}\label{ytermsydoubleprime}
    \boxed{y=\frac{dy''\cos\alpha}{
    d+x''\sin\beta+y''\sin\alpha\cos\beta}.}
\end{equation}
Figure~\ref{PitchY_C} shows that 
$g=y''\sin\alpha\sin\beta$ and that 
$x''\cos\alpha=l+g$. Using similar triangles again, 
we see that 
\begin{equation}
    \frac{x}{d} = \frac{l}{d+x''\sin\beta+
    y''\sin\alpha\cos\beta}
\end{equation}
Plugging in and simplifying, we get
\begin{equation}\label{xtermsxdoubleprime}
    \boxed{x=\frac{d(x''\cos\beta-y''\sin\alpha)}{
    d+x''\sin\beta+y''\sin\alpha\cos\beta}.}
\end{equation}

\section{\texorpdfstring{The $R$ Rotation}{The R Rotation}}

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/RotationFormula.tex}
    \caption{Here, we take a point on a plane rotated
    by angle $\beta$ about $\hat y$ and by angle
    $\alpha$ about $\hat x'$. We then rotated this point
    about a line normal to the plane going through the
    origin by angle $R$. Rotating the point is 
    equivalent to rotating the plane.}
    \label{RotationFormula}
\end{SCfigure}

We have to deal with the final rotation. We will
rotate the coordinate $(x'',y'')$ on the
previous detector about a line perpendicular to
the plane that goes through the center of the
detector. We will call this final
point $(x''',y''')$. This is shown schematically 
in figure~\ref{RotationFormula}. The equation for 
this rotation is
\begin{eqnarray}\label{rotation}
    x''&=&x'''\cos R + y'''\cos R\\
    y''&=&y'''\cos R - x'''\cos R
\end{eqnarray}
Applying equation \ref{rotation} onto equation 
\ref{xtermsxdoubleprime} and \ref{ytermsydoubleprime}
give us the relationship that we wanted all along.

\section{Relationship to Pixel Coordinates}

$(x''',y''')$ is suppose to represent what we actually
measure on a real detector. Unfortunately, things are
not quite so easy. We do not actually measure these
values. The whole formalism assumes that we are 
measuring distances from the point on the
detector where the beam would hit were it not to be
diffracted. Unfortunately, it is not at all clear
what this point is. A discussion of how to find
this center center will
be given in section~\ref{calibration}, but for now
lets simply note that there is some point on the detector
that is the center and call it $(x_c,y_c)$ 
We are interested in some other pixel reading
on the detector which corresponds to the point
$(x''',y''')$. Lets call it $(x_d,y_d)$. 
There is some material property of the detector 
describing the distance between each pixel
(e.g. \unit[1000]{mm/pixel}). We will call
this width $ps$. We can relate these quantities 
using:
\begin{align}\label{conversionToPixels}
    x'''&=(x_d-x_c) \times ps &
    y'''&=(y_d-y_c) \times ps
\end{align}
This means that, in terms of $(x_c,y_c)$ and $ps$,
we can relate $(x,y)$ and $(x_d,y_d)$ which are
directly measurable experimental quantities.

\section{Inverting the Equations}

We can invert these formula to learn what
$x''$ and $y''$ are in terms of $x$ and $y$.
We have:
\begin{equation}\label{invertx}
    x''=\frac{dx}{d\cos\beta-x\sin\beta-
    \cos\beta(x\cos\beta+d)/(\tfrac{x}{y}\cot\alpha+1)}
\end{equation}
and
\begin{equation}\label{inverty}
    y''=\frac{dx\cos\beta/(\tfrac{x}{y}\cos\alpha+\sin\alpha)}
    {d\cos\beta-x\sin\beta-
    \cos\beta(x\cos\beta+d)/(\tfrac{x}{y}\cot\alpha+1)}.
\end{equation}

\section{\texorpdfstring{$Q$, $2\theta$, and $\chi$}{Q, 2theta, and chi}}

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/TwoTheta.tex}
    \caption{For a particular point $(x,y)$, we
    always associate two quantities: $2\theta$ and $\chi$.
    $2\theta$ is the angle of scattering 
    of the beam, or the angle that an incoming beam is 
    deflected by when it diffracts off the crystal. 
    $\chi$ is a measure of the azimuthal angle around 
    the beam. It tells you in what direction radially 
    outwards (with respect to the undeflected beam) 
    the outgoing beam was was scattered.}
    \label{TwoTheta}
\end{SCfigure}

We now have a way of relating $(x''',y''')$, 
a point on a detector with a pitch $\beta$, 
tilt $\alpha$, and a roll $R$ applied to it, 
to a point on an untilted detector $(x,y)$
where a beam of light would have intersected
were it not to hit the tilted detector.
With this relationship, we can now relate
these quantities to theoretically motivated 
quantities. In particular, the angle of scattering 
of a beam is by convention called $2\theta$ and a 
quantity measuring the scattering angle around the 
incoming beam is called $\chi$. These quantities 
are shown in figure~\ref{TwoTheta}. We can see that 
the relationship between $(x,y)$ and $2\theta$ and 
$\chi$ is
\begin{equation}\label{2thetatermsr}
    \tan2\theta = \frac{r}{d} = \frac{\sqrt{x^2+y^2}}{d}
\end{equation}
and
\begin{equation}\label{chitermsyx}
    \tan\chi = \frac{y}{x}
\end{equation}
The quantity $Q$ is often used instead of $2\theta$. 
they are related by
\begin{equation}\label{qterms2theta}
    Q = 4\pi \sin(2\theta/2)/\lambda
\end{equation}
The reason for using $Q$ instead of $2\theta$ is because 
diffraction theory shows that the $Q$ values of preferential 
scattering of a crystal is a material property independent 
of the experimental setup (such as $d$ and $\lambda$). 

Alternately, energy could be used in this formula.
To do so, energy can be related to wavelength using
the De Broglie's formula
\begin{equation}
E = hc/\lambda
\end{equation}
Finally, sometimes people use the quantity $D$ instead.
$D$ is related to $Q$ by
\begin{equation}\label{DtermsQ}
    D = 2\pi/Q
\end{equation}
Using equation~\ref{conversionToPixels},
we now have a way of relating pixel
coordinates $(x_d,y_d)$ read directly off
of a detector to the
theoretically motivated coordinates $(Q,\chi)$.
In order to do this conversion, we must use
the values $x_c$, $y_c$, $ps$, $d$, $\lambda$,
$\alpha$, $\beta$, and $R$. A discussion of
how these values can be determined so that
this transformation can in practice be done
will be given in section~\ref{calibration}


%\section{Implementation In Code}
%
%For reference, this section present the C source 
%code used in the computer program to perform the 
%transformation from pixel values on a tilted 
%detector to $(Q,\chi)$ and back again. 
%Listing~\ref{getTwoThetaChi} presents the function
%\code{getTwoThetaChi()} which converts real pixel
%coordinates $(x_d,y_d)$, called \code{xPixel}
%and \code{yPixel}, into the values $2\theta$ and $\chi$, 
%called \code{twoTheta} and \code{chi} using the 
%transformation described above. In order to perform 
%this transformation, the program must be given
%the values $x_c$, $y_c$, $ps$, $d$, 
%$\alpha$, $\beta$, and $R$. For $x_c$ and $y_c$, 
%the function takes in the variables $xCenter$ and
%$yCenter$. The program takes in \code{pixelLength} 
%and \code{pixelHeight} for $ps$ to identify the
%width and height of each pixel (which should be the 
%same). The program takes in the sines and cosines
%of $\alpha$, $\beta$, and $R$ to allow for increased
%efficiency. These variables are called \code{ cos\_beta}
%\code{sin\_beta},\code{cos\_alpha},\code{sin\_alpha},
%\code{cos\_rotation}, and \code{sin\_rotation}. 
%Note that this function calculates $2\theta$ instead
%of $Q$ or $D$ but it takes a trivial amount of work
%to the additional conversion.
%\begin{lstlisting}[caption={Code to convert pixel coordinates on a real detector into $(Q,\chi)$ coordinates},label=getTwoThetaChi]
%The Code will go here one of these days...
%\end{lstlisting}
%Listing~\ref{getXY} presents the function \code{getXY()} 
%which does the inverse transformation of 
%function~\ref{getTwoThetaChi}. It uses the same
%terminology for parameters as that function.
%
%\begin{lstlisting}[caption={Code to convert $(Q,\chi)$ values into pixel coordinates on a real detector},label=getXY]
%Other code will go here one of these days...
%\end{lstlisting}
%
