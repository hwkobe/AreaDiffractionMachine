\chapter{Detector Geometries}\label{theory_chapter}

X-ray diffraction can be modeled as in figure~\ref{DiffractionSetup}. 
Cones of light preferentially leave a crystal at particular angles to 
the incoming beam. These cones of light are 
captured by a detector. The scattering angle 
of an x-rays is called 
$2\theta$. Usually, the interesting thing to measure by doing x-ray 
diffraction is $2\theta$. If we placed a detector perpendicular 
to the incoming beam, the cones of light would be detected as 
circles of high intensity. 
If we knew the distance $d$ from the sample to the detector and 
the distance $r$ from the center of the detector to a 
particular ring, we could easily calculate the scattering angle 
of the light 
\begin{equation}
    \tan2\theta = \frac{r}{d}.
\end{equation}
This is shown in figure~\ref{MeasureAngleFlatDetector}. 
Life is not always so simple. The detector is never
exactly perpendicular to the incoming beam.  In practice, 
the detector will always be slightly titled with respect 
to the incoming beam. Failing to account for this would
introduce a systematic error in the angle measurements.

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/DiffractionSetup.tex}
    \caption{An X-Ray diffraction setup. X-rays scatter from a 
    3-D sample and are captured by a 2-D detector. In this 
    setup, the detector is perpendicular to the incoming 
    x-ray beam.}
    \label{DiffractionSetup}
\end{SCfigure}

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/MeasureAngleFlatDetector.tex}
    \caption{The same setup as in figure~\ref{DiffractionSetup}. 
    $2\theta$ is the scattering angle of the light,
    $d$ is the distance 
    from the crystal to the detector, and $r$ is the distance 
    from the center of the detector.}
    \label{MeasureAngleFlatDetector}
\end{SCfigure}

There is a need to analyze diffraction data on detectors that are 
not perpendicular to the incoming x-rays. We will present a 
theory of tilted detectors first developed by Abhik Kumar 
in~\cite{Kumar05}.\index{Abhik Kumar} Our derivation will result in 
different formulas because of different assumptions
about how the detector is tilted. 

What we are interested in relating
coordinates on a tilted detector 
to theoretically motivated quantities such as 
the scattering angles of the beam that hit the
detector. We must first work
out the transformation of points on a tilted detector
to points on an untilted detector a known distance
away. This is to say
that we want to figure out where on an untilted 
detector a beam would have hit were it to hit
the untilted detector instead of the tilted detector.
We will call the point on the untilted detector
as measured on the untilted detector $(x,y)$ 
and the corresponding point on the tilted detector
as measured on the tilted detector as $(x''',y''')$. 
The reason for the three primes will become obvious
shortly. This is shown in 
figure~\ref{PhysicalSetup}. Another way to think
about this is to imagine putting your 
head at the crystal and looking directly 
at some point on a real
detector. What we want to figure out
is the corresponding point that we would be looking
at the imagined untilted detector.

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/PhysicalSetup.tex}
    \caption{Here, the detector 
    is titled with respect to the 
    incoming beam. We will call a point on 
    the tilted detector $(x''',y''')$. We are interested in 
    relating this point to the point $(x,y)$ on an imagined 
    untilted detector.}
    \label{PhysicalSetup}
\end{SCfigure}

\section{The Three Tilt Angels}
\index{$\alpha$} \index{$\beta$} \index{Rotation} \index{Tilt}
In order to relate these points, we need to find a way to 
describe an arbitrary tilt. To do so, we will 
characterize a titled detector as an untitled detector
that has 3 successive rotations applied to it. 
We will first rotate the detector about the detector's $y$
axis. We will then rotate the detector about the detectors
new $x'$ axis. Finally, we will rotate the detector about
a vector normal to the detector going through its center.
These rotations are shown in figure~\ref{ThreeTilts}.
We can solve our original problem much easier if we deal
with each rotation separately.

\begin{figure}[htb]
    \centering
    \subfloat[The tilt angle $\beta$. This angle characterizes
    a rotation around the $\hat{y}$ axis.]{
    \label{beta}\input{figures/BetaRotation.tex}}\;\;
    \subfloat[The tilt angle $\alpha$. This angle characterizes
    a rotation around the $\hat{x}'$ axis. What 
    exactly $\hat{x}'$ is will be described shortly]{
    \label{alpha}\input{figures/AlphaRotation.tex}}\;\;
    \subfloat[The rotation angle $R$. This is a rotation about
    a vector normal to $\hat{x}''$ and $\hat{y}''$]{
    \label{R_fig}\input{figures/Rotation.tex}}
    \caption{Any detector tilt can be characterized 
    by three successive rotations.}
    \label{ThreeTilts}
\end{figure}

\section{\texorpdfstring{The $\beta$ Tilt}{The beta Tilt}}

\begin{figure}[htb]
    \centering
    \subfloat[]{\label{PitchX_A}\input{figures/PitchX_A.tex}} 
    \hfill
    \subfloat[]{
    \label{PitchX_B}\input{figures/PitchX_B.tex}}
    \caption{A diagram of the situation depicted in 
    figure~\ref{PhysicalSetup} where only the 
    $\beta$ rotation about $\hat y$ has been applied.}
    \label{PitchX}
\end{figure}

We will first apply to our untitled detector a rotation 
around $\hat{y}$ by angle $\beta$.
We begin with a point $(x,y)$ on an
untilted detector and relate it to its corresponding point 
$(x',y')$ on the rotated detector.
A diagram of this is shown in figure~\ref{PitchX}.  
We can use the geometry of these diagrams 
relate these coordinates. Using
similar triangles, we have
\begin{equation}
    \frac{x}{d}=\frac{x'\cos\beta}{d+x'\sin\beta}.
\end{equation}
Or
\begin{equation}\label{xTermsxPrime}
    \boxed{x = \frac{dx'\cos\beta}{d+x'\sin\beta}}
\end{equation}
Again, we have
\begin{align}
    \frac{y}{a}&=\frac{y'}{a+b}\\
    \frac{d}{a}&=\frac{d+x'\sin\beta}{a+b}.
\end{align}
It follows that
\begin{equation}\label{yTermsxPrime}
	\boxed{y= \frac{dy'}{d+x'\sin\beta}}
\end{equation}
Equation~\ref{xTermsxPrime} and \ref{yTermsxPrime} are 
the equations relating a point on an
untilted detector to the corresponding point 
on the tilted detector.

\section{\texorpdfstring{The $\alpha$ Roll}{The alpha Roll}}

We take the point $(x',y')$ on the tilted 
plane and relate it to the point $(x'',y'')$ on a
plane rotated first $\beta$ about $\hat y$ and by
$\alpha$ around $\hat{x}'$. 
Figure~\ref{PitchY_A} is a diagram of these planes.
Figure~\ref{PitchY_B} is a more geometrical diagram.
Figure~\ref{PitchY_C} shows a cross section of the $y=0$
axis.

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/PitchY_A.tex} 
    \label{PitchY_A}
    \caption{A diagram of a plane that has been 
    rotate by angle $\beta$ about the $\hat y$ axis 
    and then by $\alpha$ around the $\hat x'$ axis.}
\end{SCfigure}

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/PitchY_B.tex} 
    \label{PitchY_B}
    \caption{A more geometrical diagram
    of the figure in figure~\ref{PitchY_A}.}
\end{SCfigure}

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/PitchY_C.tex} 
    \label{PitchY_C}
    \caption{A cross section of the $y=0$ plane.}

\end{SCfigure}

From figure~\ref{PitchY_C}, we see  
that $f=y''\sin\alpha\cos\beta$. From figure~\ref{PitchY_B},
we see that $h=y''\cos\alpha$. Using similar
triangles
\begin{equation}
    \frac{y}{a} = \frac{y''\cos\alpha}{a+b+c}.
\end{equation}
Using similar triangles again
\begin{equation}
    \frac{d}{a} = \frac{d+x''\sin\beta+f}{a+b+c}.
\end{equation}
We deduce that
\begin{equation}\label{ytermsydoubleprime}
    \boxed{y=\frac{dy''\cos\alpha}{
    d+x''\sin\beta+y''\sin\alpha\cos\beta}}
\end{equation}
Figure~\ref{PitchY_C} shows that 
$g=y''\sin\alpha\sin\beta$ and that 
$x''\cos\alpha=l+g$. Using similar triangles again 
\begin{equation}
    \frac{x}{d} = \frac{l}{d+x''\sin\beta+
    y''\sin\alpha\cos\beta}
\end{equation}
Plugging in and simplifying
\begin{equation}\label{xtermsxdoubleprime}
    \boxed{x=\frac{d(x''\cos\beta-y''\sin\alpha)}{
    d+x''\sin\beta+y''\sin\alpha\cos\beta}}
\end{equation}

\section{\texorpdfstring{The $R$ Rotation}{The R Rotation}}

We now deal with the final rotation. We relate
the coordinate $(x'',y'')$ on the previous tilted 
detector to the point $(x''',y''')$ on a detector 
tilted about a line normal to this detector going 
through its center. These points are related by
\begin{align}
    x''&=x'''\cos R + y'''\cos R\label{rotation1}\\
    y''&=y'''\cos R - x'''\cos R\label{rotation2}
\end{align}
Applying equation~\ref{rotation1} and \ref{rotation2}
to equation \ref{xtermsxdoubleprime} and \ref{ytermsydoubleprime}
gives us the needed relationship between a point on an untilted
detector and the corresponding point on a tilted detector.

\section{Pixel Coordinates}

$(x''',y''')$ represents the distance between the center 
and a point on the real detector. We do not actually
measure this distance. What we actually have experimentally
are pixel coordinates on a detector. There is some pixel 
coordinate on the detector corresponding to the center of
the detector\footnote{This is the point that the x-rays would
hit were they not to diffract off the crystal}. We will call 
it $(x_c,y_c)$.  We will call the pixel coordinate on the detector
$(x_d,y_d)$ that corresponds to the point $(x''',y''')$.
We want to relate ($x_d,y_d$) which we measure directly
to $(x''',y''')$ and then to $(x,y)$.
There is some material property of the detector 
describing the width of each pixel
(e.g. \unit[1000]{mm/pixel}). We will call
this width $pl$. There is a corresponding
quantity that is the height of each pixel.
We can relate the pixel coordinates to the physical distances
by
\begin{align}\label{conversionToPixels}
    x'''&=(x_d-x_c) \times pl &
    y'''&=(y_d-y_c) \times ph.
\end{align}

\section{Inverting the Equations}

We can invert these formula to learn what
$x''$ and $y''$ are in terms of $x$ and $y$.
We have:
\begin{equation}\label{invertx}
    x''=\frac{dx}{d\cos\beta-x\sin\beta-
    \cos\beta(x\cos\beta+d)/(\tfrac{x}{y}\cot\alpha+1)}
\end{equation}
and
\begin{equation}\label{inverty}
    y''=\frac{dx\cos\beta/(\tfrac{x}{y}\cos\alpha+\sin\alpha)}
    {d\cos\beta-x\sin\beta-
    \cos\beta(x\cos\beta+d)/(\tfrac{x}{y}\cot\alpha+1)}.
\end{equation}

\section{\texorpdfstring{$Q$, $2\theta$, and $\chi$}{Q, 2theta, and chi}}

We now have a way of relating $(x''',y''')$, 
a point on a detector rotated by angle $\beta$, 
$\alpha$, and $R$ to a point $(x,y)$
on an untilted detector.
We relate $(x,y)$ to theoretically motivated 
quantities. $2\theta$, the angle of scattering 
of a beam, is calculated as
\begin{equation}\label{2thetatermsr}
    \tan2\theta = \frac{r}{d} = \frac{\sqrt{x^2+y^2}}{d}.
\end{equation}
$\chi$, the angle around the beam, is calculated as
\begin{equation}\label{chitermsyx}
    \tan\chi = \frac{y}{x}.
\end{equation}
$Q$ is calculated as
\begin{equation}\label{qterms2theta}
    Q = 4\pi \sin(2\theta/2)/\lambda.
\end{equation}
Diffraction theory shows that the $Q$ values of preferential 
scattering for a crystal are a material property independent 
of the experimental setup. 
We could use energy instead of wavelength in this formula 
using the De Broglie's formula
\begin{equation}
    E = hc/\lambda.
\end{equation}
Some people use the quantity $D$ instead of $Q$
\begin{equation}\label{DtermsQ}
    D = 2\pi/Q.
\end{equation}

\begin{SCfigure}[1][htbp]
    \centering
    \input{figures/TwoTheta.tex}
    \caption{For a particular point $(x,y)$ on an 
    untilted detector, we define two quantities:
    $2\theta$ and $\chi$. $2\theta$ is the angle of 
    scattering of the beam. $\chi$ is a measure of the 
    azimuthal angle of the scattered light around 
    the beam.}
    \label{TwoTheta}
\end{SCfigure}

We now have a way of relating pixel
coordinates $(x_d,y_d)$ read directly off
of a detector to the
theoretically motivated coordinates $(Q,\chi)$.
This relationship assumes that we know
$x_c$, $y_c$, $pl$, $ph$, $d$, $\lambda$,
$\alpha$, $\beta$, and $R$. A discussion of
how these values can be determined experimentally
is given in section~\ref{calibration}.

%\section{Implementation In Code}
%
%For reference, this section present the C source 
%code used in the computer program to perform the 
%transformation from pixel values on a tilted 
%detector to $(Q,\chi)$ and back again. 
%Listing~\ref{getTwoThetaChi} presents the function
%\code{getTwoThetaChi()} which converts real pixel
%coordinates $(x_d,y_d)$, called \code{xPixel}
%and \code{yPixel}, into the values $2\theta$ and $\chi$, 
%called \code{twoTheta} and \code{chi} using the 
%transformation described above. In order to perform 
%this transformation, the program must be given
%the values $x_c$, $y_c$, $ps$, $d$, 
%$\alpha$, $\beta$, and $R$. For $x_c$ and $y_c$, 
%the function takes in the variables $xCenter$ and
%$yCenter$. The program takes in \code{pixelLength} 
%and \code{pixelHeight} for $ps$ to identify the
%width and height of each pixel (which should be the 
%same). The program takes in the sines and cosines
%of $\alpha$, $\beta$, and $R$ to allow for increased
%efficiency. These variables are called \code{ cos\_beta}
%\code{sin\_beta},\code{cos\_alpha},\code{sin\_alpha},
%\code{cos\_rotation}, and \code{sin\_rotation}. 
%Note that this function calculates $2\theta$ instead
%of $Q$ or $D$ but it takes a trivial amount of work
%to the additional conversion.
%\begin{lstlisting}[caption={Code to convert pixel coordinates on a real detector into $(Q,\chi)$ coordinates},label=getTwoThetaChi]
%The Code will go here one of these days...
%\end{lstlisting}
%Listing~\ref{getXY} presents the function \code{getXY()} 
%which does the inverse transformation of 
%function~\ref{getTwoThetaChi}. It uses the same
%terminology for parameters as that function.
%
%\begin{lstlisting}[caption={Code to convert $(Q,\chi)$ values into pixel coordinates on a real detector},label=getXY]
%Other code will go here one of these days...
%\end{lstlisting}
